services:
  # MinIO - Armazenamento S3-compatible
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"   # API
      - "9091:9090"   # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9090"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO Client - Para criar buckets automaticamente
  minio-setup:
    image: minio/mc:latest
    container_name: minio-setup
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/raw --ignore-existing;
      mc mb myminio/processed --ignore-existing;
      mc mb myminio/models --ignore-existing;
      exit 0;
      "

  # PostgreSQL - Banco de dados
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: weather_db
    ports:
      - "5434:5432"   # Porta externa 5433 para evitar conflito com ThingsBoard
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql_scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI - Ingestão de dados
  fastapi:
    build:
      context: ./fastapi
      dockerfile: Dockerfile
    container_name: fastapi
    ports:
      - "8000:8000"
    environment:
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      POSTGRES_HOST: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: weather_db
    volumes:
      - ./fastapi:/app
      - ./data:/app/data
    depends_on:
      minio:
        condition: service_healthy
      postgres:
        condition: service_healthy
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # JupyterLab - Análise e modelagem
  jupyterlab:
    build:
      context: ./jupyterlab
      dockerfile: Dockerfile
    container_name: jupyterlab
    ports:
      - "8880:8888"
    environment:
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      POSTGRES_HOST: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: weather_db
      MLFLOW_TRACKING_URI: http://mlflow:5000

      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_DEFAULT_REGION: us-east-1
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
    volumes:
      - ./notebooks:/home/jovyan/work/notebooks
      - ./data:/home/jovyan/work/data
      - ./data_utils.py:/home/jovyan/work/data_utils.py
      - jupyter_data:/home/jovyan/work
    depends_on:
      - postgres
      - minio
      - mlflow
    command: start-notebook.sh --NotebookApp.token='' --NotebookApp.password='' --NotebookApp.allow_origin='*'

  # MLFlow - Versionamento de modelos
  mlflow:
    build:
      context: ./mlflow
      dockerfile: Dockerfile
    image: custom-mlflow
    container_name: mlflow
    ports:
      - "5001:5000"
    environment:
      MLFLOW_BACKEND_STORE_URI: postgresql://postgres:postgres@postgres:5432/weather_db
      MLFLOW_DEFAULT_ARTIFACT_ROOT: s3://models/
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_DEFAULT_REGION: us-east-1 
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
    volumes:
      - mlflow_data:/mlflow
    depends_on:
      - postgres
      - minio
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri postgresql://postgres:postgres@postgres:5432/weather_db
      --default-artifact-root s3://models/

  thingsboard:
    image: "thingsboard/tb-postgres"
    container_name: thingsboard
    restart: always
    ports:
      - "8080:9090"        # HTTP (você acessa pelo navegador em localhost:8080)
      - "1883:1883"        # MQTT (se quiser usar depois)
      - "7070:7070"        # RPC (não precisamos agora)
      - "5683-5688:5683-5688/udp"
    environment:
      TB_QUEUE_TYPE: in-memory   # fila em memória é suficiente pro projeto
    volumes:
      - tb_data:/data
      - tb_logs:/var/log/thingsboard

  trendz-postgres:
    image: postgres:15
    container_name: trendz-postgres
    restart: always
    environment:
      POSTGRES_DB: trendz
      POSTGRES_USER: trendz
      POSTGRES_PASSWORD: trendz
    volumes:
      - trendz_db_data:/var/lib/postgresql/data

  trendz-python:
    image: thingsboard/trendz-python-executor:1.14.0
    container_name: trendz-python
    restart: always
    ports:
      - "8181:8181"
    environment:
      SCRIPT_ENGINE_RUNTIME_TIMEOUT: 30000
    volumes:
      - trendz_python_data:/python-executor

  trendz:
    image: "thingsboard/trendz:1.14.0"
    container_name: trendz
    restart: always
    ports:
      - "8888:8888"
    environment:
      TB_API_URL: http://thingsboard:9090
      TRENDZ_LICENSE_SECRET: TWUOvIdrNIAXWLDWUS3NhK2x
      TRENDZ_LICENSE_INSTANCE_DATA_FILE: /data/license.data

      SPRING_DATASOURCE_URL: jdbc:postgresql://trendz-postgres:5432/trendz
      SPRING_DATASOURCE_USERNAME: trendz
      SPRING_DATASOURCE_PASSWORD: trendz

      SCRIPT_ENGINE_PROVIDER: DOCKER_CONTAINER
      SCRIPT_ENGINE_DOCKER_PROVIDER_URL: trendz-python:8181
      SCRIPT_ENGINE_TIMEOUT: 30000

    volumes:
      - trendz_data:/data
      - trendz_logs:/var/log/trendz
    depends_on:
      - trendz-postgres
      - trendz-python
      - thingsboard



volumes:
  minio_data:
  postgres_data:
  jupyter_data:
  mlflow_data:
  trendz_data:
  tb_data:
  tb_logs:
  trendz_logs:
  trendz_python_data:
  trendz_db_data:



networks:
  default:
    name: weather_network

